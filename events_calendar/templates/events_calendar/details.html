{% extends 'base.html' %}
{% load static %}
{% load thumbnail %}
{% block content %}
    <br><br>

<script type="text/javascript">
    function updateComments() {
        $.ajax({
            url: "{% url 'calendar:comments' event.id %}",
            cache: false,
            success: function(html){
                $("#comments").html(html);
            }
        });
    }
    $(document).ready(function(){
        updateComments();
        setInterval('updateComments()',5000);
    });
</script>
{% autoescape on %}
<div class="row">
    <div class="col-lg-8 col-sm-12">
        <span class="title-font">{{ event.name }}</span>
        <span class="event-date text-info" style="color: #a1a1a1">{{ event.start_date }}</span>
    </div>
</div>
<div class="row">
    <div class="col-lg-4 col-sm-12">
        {% thumbnail event.image "850x500" format="PNG" crop="" as im %}
            <img src="/media/{{ im.url }}" width="100%">
        {% endthumbnail %}
    </div>
    <div class="col-lg-4 col-sm-12">

        <form class="form-horizontal" id="subscribe_form" action="{% url 'calendar:subscribe' %}" method="post">
            {% csrf_token %}
            {% if event.creator.image %}
                {% thumbnail event.creator.image "30x30" format="PNG" crop="" as im %}
                    <img src="/media/{{ im.url }}" class="img-rounded" width="{{ im.width }}" height="{{ im.height }}">
                {% endthumbnail %}
            {% endif %}
            <a href="{% url 'calendar:filter_by_organization' event.creator.id %}"><span class="text-info" style="color: #859aff; font-size: larger">{{ event.creator.name }}</span></a>
            &nbsp;&nbsp;&nbsp;<input type="hidden" name="event" value="{{ event.id }}">
            {% if user.username %}
                {% if event.creator in signed_organizations %}
                    <input type="hidden" name="sub" value="Unsubscribe">
                    <input id="subscribe_button" class="btn btn-default" type="submit" value="Відписатись">
                {% else %}
                    <input type="hidden" name="sub" value="Subscribe">
                    <input id="subscribe_button" class="btn btn-primary" type="submit" value="Підписатися">
                {% endif %}
            {% endif %}
        </form>
        <form class="form-horizontal" action="{% url 'calendar:insert_into_google_calendar' %}" method="post"
        onsubmit="alert('Ця подія додана у ваш google календар');">
            {% csrf_token %}
            <input type="hidden" name="event_id" value="{{ event.id }}">
            <input type="submit" value="Додати в google календар" class="btn btn-primary">
        </form>
        {% if event.place_of_event != None %}
            <span class="text-info" style="color: #a1a1a1; font-size: large">{{ event.place_of_event }}</span><br>
        {% endif %}

        {% if event.vk_link != None %}
            <span class="text-info"><a href="{{ event.vk_link }}" target="_blank">Посилання вк</a></span><br>
        {% endif %}

        {% if event.fb_link != None %}
            <a href="{{ event.fb_link }}" target="_blank">Посилання facebook</a><br>
        {% endif %}

        {% if event.web_site != None %}
            <span class="text-info"><a href="{{ event.web_site }}" target="_blank">Посилання на сайт події</a></span><br>
        {% endif %}
    </div>
</div>
<div class="row">
    <div class="col-lg-8 col-sm-12">
        <br>
        <span class="description-font" style="margin-bottom: 10px; margin-top: 10px">{{ event.description|linebreaks }}</span><br>
        <span class="text-info" style="color: #a1a1a1; font-size: large">{{ event.category.name }}</span>
        {% if event.end_date != None %}
            <span class="event-date text-info" style="color: #a1a1a1">{{ event.end_date }}</span>
        {% endif %}
    </div>
</div>
<div class="row">
    <div class="col-lg-8 col-sm-12">
        <hr>
        {% if user.username %}
        {% else %}
            <span class="text-comment"><a href="{% url 'loginsys:login' %}">Виконайте вхід,</a> щоб залишити свій коментар</span>
            <br><br>
        {% endif %}
        <div id="comments">
        </div>
        <div class="row">
            {% if user.username %}

            <form id="form" class="form-horizontal" onsubmit="getAjax()" action="javascript:void(null);">
                {% csrf_token %}
                <div class="col-lg-1 col-md-1 col-sm-1 col-xs-2">
                    {% thumbnail user.profile.image "50x50" format="PNG" crop="" as im %}
                        <img src="/media/{{ im.url }}" class="img-rounded" width="{{ im.width }}" height="{{ im.height }}">
                    {% endthumbnail %}
                </div>
                <div class="col-lg-11 col-md-11 col-sm-11 col-xs-10">
                    <!--<input id="input_comment" class="form-control" placeholder="Відправити Enter"   name="text">-->
                    <textarea id="input_comment" class="form-control" placeholder="Відправити Enter" name="text" style="max-width: 100%; max-height: 50px"></textarea>
                </div>

                <script type="text/javascript">
                    function getAjax() {
                        var textComment   = $('#form').serialize();
                        $.ajax({
                            url: "{% url 'calendar:add_comment' event.id %}",
                            type: 'POST',
                            data: textComment
                        });
                        $("#input_comment").val('');
                        $("#input_comment").blur();
                        updateComments();
                    }
                    $(document).ready(function(){
                        $("#input_comment").keypress(function(e){
                            if(e.keyCode==13){
                                $("#form").submit();
                            }
                        });
                    });
                </script>
            </form>
                <br><br><br><br><br>
            {% endif %}
        </div>
    </div>
</div>
    <script type="text/javascript">
        function clickable(){
            var codeElems = $(".description-font"); //jQuery
            var regStr= /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            for (var c=0; c<codeElems.length; c++){
                codeElems[c].innerHTML=codeElems[c].innerHTML.replace(regStr, '<a href="$1" target="blank">$1</a>');
            }
        }
        clickable();
    </script>
{% endautoescape %}
{% endblock %}